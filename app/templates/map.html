{% extends 'base.html' %}

{% block head %}
{{super()}}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
crossorigin=""/>
 <!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>
<script src="{{ url_for('static', filename='js/leaflet-providers.js') }}"></script>

{% endblock %}

{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .leaflet-control-layers-list {
            text-align: left;
        }
        .avatar-circled {
            clip-path: circle(70px at center);
        }
    </style>
{% endblock %}

{% block scripts %}
{{super()}}
<script src="{{ url_for('static', filename='js/Polyline.encoded.js') }}"></script>
<script src="{{ url_for('static', filename='js/leaflet-hash.js') }}"></script>
<!-- 
<script src="{{ url_for('static', filename='js/jquery.ajax-retry.min.js') }}"></script>
 -->
 <script>
    const encoded_pl="gqabGd`tpLsCb@KZBfBuArFU^uAr@mEvA}UtDkNtCSz@kE|@t@`NIr@yU^yDnB}B~CyAn@{@jBcGsHq@YmBC_A_BeDaDiCuJeDyPaB_R}F_UWiBa@mH{CoI}A_GiKdEqHtEsB_@}BaC}@YkIBgBkFWSoYrHgDhBwLzIkJ|JyG~F{MpIkIhKgCtAaCPkCSm[wIQa@t@_HIi@{Bu@cLqHaDg@mGv@q@_@wEkEmB}CwAuAmB]kCb@sI?qK_FCY^wAJwA_@mINgLbCwf@c@iD{BsEsAaEc@_CAkBOUc@@wEjBwNpJeKbEqMbAcJfDcGxCkIdCwI|AgErB]Gt@}MzAwOnAgFzHqWxBuMrAqCzBkDhQeRrBqDEk@YM{BLkBTeAjAw@Jy@w@oA_CkAOoDnAiLlI{@CeCqBw@CgA^gAjA{EtJaGzC_FxAeAr@_AlAuMhV_@dBQfFUl@{BCaK{AeN`Ak@rI?lCZlFz@pGBpDkCnPsFpc@y@fCwCfESNQOyFsL{CyEgAy@iCm@gDRqHrB_O`K_Dj@wEX[nHaEjRsBtFmGlWgBfM}E~Lo@lW[jCgEbEuKnHwBrB}AzEgCnFk@fBWxBObE}@fEqA|BkFrGy@rBKdCnAtNThK\\`Hs@xFqEpP}@pG[r@o@Y}VcVoQuLWg@s@uGs@wDb@ePOyF`A}AdA_FpFsEdDsBjCaDnAoEnA_Jv@wCr@y@lHU~AJbDrAbF|DvCnCfB^hAn@nABnAl@pA{AnAiCfAoExHsGjDkBpCiCzAuBz@c@xBVfHFv@XzArA~Bt@|EP`K]lTtBzA]dCiCnAk@fC?jLlBnF@fBWjJeEpC}CvEcKdHkQjAqBIm@qBeEgH}SkAgFAgE\\sE~@sCfB_DlCsCnVcU`DeDnAqBxBeCvH_GnByCjEgLp@s@lEcCvJsBvJwCdGaDrCeAxEy@`Kk@zAg@hBkAdD}@zOiKxA[`@e@rBs@VPVnCx@|ChDjHXdCyBvd@a@nN@bBj@dFQrB_@vAHR~CrBhG|B`IJ~Bg@hBb@lDbEdC`BfBtBz@h@zADxE{@tCh@nHtFxEtBk@tHLv@fZrI|Bb@bB?nBYlB_A~I{KzQqLbCuB`IiJjPcMfE}AhVoGh@^tAfExIFx@^~B~BlAVvAUzDqCdLiFh@@nAtFvBtF`@dBp@tJhGdVfAtNlD~QjCrKXh@pCjCz@rBjBKr@PhBhCjDtDXMb@gAhAi@lBqCpDsCvVUJW?eAu@oLD]bEs@Nq@j@UhG_AdGaBlUmDzFqB`BoFDgDnDw@";
    var polly = L.PolylineUtil.decode(encoded_pl);


    // add Stamen Watercolor to map.
    var stamen_wc = L.tileLayer.provider('Stamen.Watercolor');
    var cyclosm =  L.tileLayer.provider('CyclOSM');
    var tf_ocm = L.tileLayer.provider("Thunderforest.OpenCycleMap",{apikey:'aa1d4d9511574ee5a1ebca9b7e8a5baf'});
    var tf_lands = L.tileLayer.provider("Thunderforest.Landscape",{apikey:'aa1d4d9511574ee5a1ebca9b7e8a5baf'});
    var carto_VLU = L.tileLayer.provider("CartoDB.VoyagerLabelsUnder");
    var stadia_alidade = L.tileLayer.provider('Stadia.AlidadeSmooth');
    var stadia_alidade_dark = L.tileLayer.provider('Stadia.AlidadeSmoothDark');
    var osm_mapbox = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        });
    
    var map = L.map('mapid', { layers: [carto_VLU] });
    //if (!map.restoreView()) {
    map.setView([42.2, -71.88], 8);

    var popup_route = L.popup();
    var routeLayer = L.geoJSON().addTo(map);

    const routes = [
        '_B_lackLivesMatter',
        'B_l_ackLivesMatter',
        'Bl_a_ckLivesMatter',
        'Bla_c_kLivesMatter',
        'Blac_k_LivesMatter',
        'Black_L_ivesMatter',
        'BlackL_i_vesMatter',
        'BlackLi_v_esMatter',
        'BlackLiv_e_sMatter',
        'BlackLive_s_Matter',
        'BlackLives_M_atter',
        'BlackLivesM_a_tter',
        'BlackLivesMa_t_ter',
        'BlackLivesMat_t_er',
        'BlackLivesMatt_e_r',
        'BlackLivesMatte_r_'
    ];

    
    function add_geojson(name, style) {
        const urlbase = "{{ url_for('static', filename='routes') }}";
        const url = `${urlbase}/${name}.geojson`
        // return a promise
        return $.ajax({
            url: url,
            timeout: 3000,
            dataType: "json",
            tryCount: 0,
            retryLimit: 5,
            success: function (json) {
                var gJ = L.geoJson(json, { style: style }).addTo(routeLayer);
                gJ.on('click', (e) => {
                    popup_route
                        .setLatLng(e.latlng)
                        .setContent(`Click to download route.<br><b><a href="${urlbase}/${name}.tcx">${name}.tcx</a></b>`)
                        .openOn(map);
                    L.DomEvent.stopPropagation(e);
                });

            },
            error: function (xhr, textStatus, errorThrown) {
                if (textStatus == 'timeout') {
                    this.tryCount++;
                    if (this.tryCount <= this.retryLimit) {
                        //try again
                        return $.ajax(this);
                    }
                    return;
                }
                if (xhr.status == 500) {
                    //handle error
                } else {
                    //handle error
                }
            }
        });
    }

    var i;
    var len = routes.length;
    for (i=0; i < len; i++) {
        add_geojson(routes[i], `route-${i+1}` );
    }

    //L.polyline(polly, {color:'blue'}).addTo(map);
    //L.poline(polly)

    // Set up layers control
    var baseMaps = {
        'Stamen.Watercolor'          : stamen_wc,           
        'CycOSM'                     : cyclosm   ,       
        "Thunderforest.OpenCycleMap" : tf_ocm     ,      
        "Thunderforest.Landscape"    : tf_lands    ,    
        "CartoDB.VoyagerLabelsUnder" : carto_VLU    ,    
        'Stadia.AlidadeSmooth'       : stadia_alidade,   
        'Stadia.AlidadeSmoothDark'   : stadia_alidade_dark,
        'MapBox OSM': osm_mapbox
    };

    var overlayMaps = {
        "BLM Routes": routeLayer
    };

    L.control.layers(baseMaps, overlayMaps, { collapsed: true }).addTo(map);

    /*
    // Set up hash plugin
    var allMapLayers = {
        'cyclosm': cyclosm,
        'piano': piano,
        'openstreetmap': osm,
        'opencyclemap': ocm,
        'opentopomap': otm,
        'waymarkedtrails': waymarked_trails,
        'cyclosmlite': cyclosm_lite,
        'blm_routes': routeLayer
    };
    // L.Hash(map, allMapLayers);
    */


    /* 	L.marker([51.5, -0.09]).addTo(mymap)
            .bindPopup("<b>Hello world!</b><br />I am a popup.").openPopup();
    
        L.circle([51.508, -0.11], 500, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5
        }).addTo(mymap).bindPopup("I am a circle.");
    
        L.polygon([
            [51.509, -0.08],
            [51.503, -0.06],
            [51.51, -0.047]
        ]).addTo(mymap).bindPopup("I am a polygon.");
    
     */
    /*
    var popup = L.popup();

    function onMapClick(e) {
        popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
    }
    map.on('click', onMapClick);
    */
</script>
{% endblock %}

{% block content %}
<!-- 
<div id="info">
    <h4><a href="https://github.com/leaflet-extras/leaflet-providers">Leaflet-providers preview</a></h4>
    <p>
        This page shows mini maps for all the layers available in <a
            href="https://github.com/leaflet-extras/leaflet-providers">Leaflet-providers</a>.
    </p>
</div>

<div class="github-fork-ribbon-wrapper left">
    <div class="github-fork-ribbon">
        <a href="https://github.com/leaflet-extras/leaflet-providers">Fork me on GitHub</a>
    </div>
</div>
 -->
<style>
    .wrapper {
        position: relative;
    }


    .floater {
        position: absolute;
        padding: 2px 0;
        display: inline-block;
    } 

    .floater-wrapper {
        width: 150px;
        height: 150px;
        position: absolute;
        overflow: hidden;
        top: 0;
    }


    #user-info {
        position: absolute;
        top: 40;
        right: 200;
        padding: 10px 10px;
        display: inline-block;
        z-index: 9999;
    }

    #powered-by {
        position: absolute;
        bottom: 20;
        right: 200;
        padding: 10px 10px;
        top:0;
        display: inline;
        overflow: hidden;
    }

</style>
<div class="wrapper">
    <div id="mapid"></div>
    <div id="powered-by"> 
        <img href="{{ url_for('static', filename='images/api_logo_pwrdBy_strava_stack_light.png') }}" > 
    </div>
    <div id="user-info">
        <div class="avatar-circled">
            <img href="{{ user_info.profile }}">
        </div>
    </div>
</div>


{% endblock %}
